@{
    ViewData["Title"] = "LGU Dashboard";
    Layout = "_LGULayout";
}

<div class="mb-6">
    <h1 class="text-2xl font-bold mb-1">LGU Dashboard</h1>
    <p class="text-sm text-gray-600">Welcome back! Here's an overview of your community's disaster management status.</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <!-- Summary Cards -->
    <div class="lgu-card p-4">
        <div class="flex items-center mb-4">
            <div class="header-icon bg-red-100 text-red-600">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Active Incidents</h3>
                <p class="text-sm text-gray-500">Requiring attention</p>
            </div>
        </div>
        <div class="flex justify-between items-end">
            <div class="text-3xl font-bold">@(ViewBag.ActiveIncidents ?? 0)</div>
            <div class="text-sm @(ViewBag.IncidentChangePositive != null && ViewBag.IncidentChangePositive ? "text-green-600" : "text-red-600")">
                <i class="fas @(ViewBag.IncidentChangePositive != null && ViewBag.IncidentChangePositive ? "fa-arrow-down" : "fa-arrow-up") mr-1"></i>
                @(ViewBag.IncidentChangePercentage ?? 0)% from last week
            </div>
        </div>
                    </div>

    <div class="lgu-card p-4">
        <div class="flex items-center mb-4">
            <div class="header-icon bg-blue-100 text-blue-600">
                <i class="fas fa-users"></i>
                    </div>
            <div>
                <h3 class="text-lg font-semibold">Community Activity</h3>
                <p class="text-sm text-gray-500">Recent engagement</p>
                    </div>
                </div>
        <div class="flex justify-between items-end">
            <div class="text-3xl font-bold">@(ViewBag.CommunityPosts ?? 0)</div>
            <div class="text-sm @(ViewBag.CommunityChangePositive != null && ViewBag.CommunityChangePositive ? "text-green-600" : "text-red-600")">
                <i class="fas @(ViewBag.CommunityChangePositive != null && ViewBag.CommunityChangePositive ? "fa-arrow-up" : "fa-arrow-down") mr-1"></i>
                @(ViewBag.CommunityChangePercentage ?? 0)% from last week
            </div>
        </div>
    </div>

    <div class="lgu-card p-4">
        <div class="flex items-center mb-4">
            <div class="header-icon bg-green-100 text-green-600">
                <i class="fas fa-check-circle"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Response Rate</h3>
                <p class="text-sm text-gray-500">Avg. resolution time</p>
            </div>
        </div>
        <div class="flex justify-between items-end">
            <div class="text-3xl font-bold">@(ViewBag.ResponseRate ?? 0)%</div>
            <div class="text-sm @(ViewBag.ResponseRatePositive != null && ViewBag.ResponseRatePositive ? "text-green-600" : "text-red-600")">
                <i class="fas @(ViewBag.ResponseRatePositive != null && ViewBag.ResponseRatePositive ? "fa-arrow-up" : "fa-arrow-down") mr-1"></i>
                @(ViewBag.ResponseRateChange ?? 0)% from last week
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="lgu-card mb-6">
    <div class="lgu-card-header">
        <div class="header-icon bg-primary text-white">
            <i class="fas fa-bolt"></i>
        </div>
        <h2 class="text-lg font-semibold">Quick Actions</h2>
    </div>
    <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <a href="@Url.Action("CreateAlert", "LGU")" class="btn bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg transition-all flex items-center justify-center">
                <i class="fas fa-bell mr-2"></i> Create Alert
            </a>
            <a href="@Url.Action("ManageReports", "LGU")" class="btn bg-primary hover:bg-primaryDark text-white py-3 rounded-lg transition-all flex items-center justify-center">
                <i class="fas fa-clipboard-list mr-2"></i> Manage Reports
            </a>
            <a href="@Url.Action("ResourceManagement", "LGU")" class="btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg transition-all flex items-center justify-center">
                <i class="fas fa-box mr-2"></i> Resource Management
            </a>
            <a href="@Url.Action("SendBroadcast", "LGU")" class="btn bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition-all flex items-center justify-center">
                <i class="fas fa-bullhorn mr-2"></i> Send Broadcast
            </a>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Active Alerts -->
    <div class="lgu-card">
        <div class="lgu-card-header">
            <div class="header-icon bg-red-600 text-white">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div>
                <h2 class="text-lg font-semibold mb-0">Active Alerts</h2>
                <p class="text-xs text-gray-500 mb-0">Currently active alerts in your area</p>
            </div>
        </div>
        <div class="p-4">
                @if (ViewBag.ActiveAlerts != null && ViewBag.ActiveAlerts.Count > 0)
                {
                <div class="divide-y">
                        @foreach (var alert in ViewBag.ActiveAlerts)
                        {
                        <div class="py-3 transition-all hover:bg-gray-50 rounded-md cursor-pointer">
                            <div class="flex justify-between items-start">
                                <h5 class="font-medium mb-1 flex items-center">
                                    <span class="inline-block w-2 h-2 rounded-full mr-2 @(alert.Severity == AlertSeverity.Critical ? "bg-red-600" : 
                                        alert.Severity == AlertSeverity.Danger ? "bg-orange-500" : 
                                        alert.Severity == AlertSeverity.Warning ? "bg-yellow-500" : "bg-blue-500")"></span>
                                        @alert.Title
                                    </h5>
                                <span class="text-xs text-gray-500">@alert.DateIssued.ToString("MMM dd, HH:mm")</span>
                                </div>
                            <p class="text-sm mb-1 text-gray-600">@alert.Message</p>
                            <div class="flex items-center text-xs text-gray-500">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span>@alert.AffectedArea</span>
                            </div>
                            </div>
                        }
                    </div>
                <div class="mt-4 text-center">
                    <a href="@Url.Action("ManageAlerts", "LGU")" class="inline-block px-4 py-2 text-sm text-primary border border-primary rounded-md hover:bg-primary hover:text-white transition-all">
                        Manage Alerts
                    </a>
                    </div>
                }
                else
                {
                <div class="text-center py-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <p class="text-gray-600 mb-3">No active alerts at this time.</p>
                    <a href="@Url.Action("CreateAlert", "LGU")" class="inline-block px-4 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 transition-all">
                        Create New Alert
                    </a>
                    </div>
                }
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="lgu-card">
        <div class="lgu-card-header">
            <div class="header-icon bg-primary text-white">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div>
                <h2 class="text-lg font-semibold mb-0">Recent Reports</h2>
                <p class="text-xs text-gray-500 mb-0">Latest incidents reported in your area</p>
            </div>
        </div>
        <div class="p-4">
                @if (ViewBag.RecentReports != null && ViewBag.RecentReports.Count > 0)
                {
                <div class="divide-y">
                        @foreach (var report in ViewBag.RecentReports)
                        {
                        <div class="py-3 transition-all hover:bg-gray-50 rounded-md cursor-pointer" 
                             onclick="location.href='@Url.Action("ReportDetails", "LGU", new { id = report.Id })'">
                            <div class="flex justify-between items-start">
                                <h5 class="font-medium mb-1">@report.Title</h5>
                                <span class="text-xs text-gray-500">@report.DateReported.ToString("MMM dd, HH:mm")</span>
                                </div>
                            <p class="text-sm mb-1 text-gray-600 line-clamp-1">@report.Description</p>
                            <div class="flex flex-wrap gap-1">
                                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-700">@report.Type</span>
                                <span class="px-2 py-0.5 text-xs rounded-full @(report.Severity == SeverityLevel.Low ? "bg-blue-100 text-blue-700" : 
                                    report.Severity == SeverityLevel.Medium ? "bg-yellow-100 text-yellow-700" : 
                                    report.Severity == SeverityLevel.High ? "bg-red-100 text-red-700" : "bg-gray-100 text-gray-700")">
                                        @report.Severity
                                    </span>
                                <span class="px-2 py-0.5 text-xs rounded-full @(report.Status == ReportStatus.Pending ? "bg-yellow-100 text-yellow-700" : 
                                    report.Status == ReportStatus.Verified ? "bg-blue-100 text-blue-700" : 
                                    report.Status == ReportStatus.InProgress ? "bg-purple-100 text-purple-700" : 
                                    report.Status == ReportStatus.Resolved ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-700")">
                                        @report.Status
                                    </span>
                            </div>
                        </div>
                        }
                    </div>
                <div class="mt-4 text-center">
                    <a href="@Url.Action("ManageReports", "LGU")" class="inline-block px-4 py-2 text-sm text-primary border border-primary rounded-md hover:bg-primary hover:text-white transition-all">
                        Manage All Reports
                    </a>
                    </div>
                }
                else
                {
                <div class="text-center py-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
                        <i class="fas fa-clipboard-check text-3xl"></i>
                    </div>
                    <p class="text-gray-600">No recent reports in your area.</p>
                    </div>
                }
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Resource Status -->
    <div class="lgu-card">
        <div class="lgu-card-header">
            <div class="header-icon bg-blue-500 text-white">
                <i class="fas fa-box"></i>
            </div>
            <div>
                <h2 class="text-lg font-semibold mb-0">Resource Status</h2>
                <p class="text-xs text-gray-500 mb-0">Available emergency resources</p>
            </div>
        </div>
        <div class="p-4">
            <div class="space-y-3">
                <div class="resource-item">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Food Supplies</span>
                        <span class="text-sm">75%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
                    </div>
                </div>
                <div class="resource-item">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Medical Kits</span>
                        <span class="text-sm">45%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full" style="width: 45%"></div>
                    </div>
                </div>
                <div class="resource-item">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Emergency Vehicles</span>
                        <span class="text-sm">90%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 90%"></div>
                    </div>
                </div>
                <div class="resource-item">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Temporary Shelters</span>
                        <span class="text-sm">30%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" style="width: 30%"></div>
                    </div>
                </div>
                <div class="resource-item">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Rescue Personnel</span>
                        <span class="text-sm">65%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 65%"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <a href="@Url.Action("ResourceManagement", "LGU")" class="inline-block px-4 py-2 text-sm text-blue-500 border border-blue-500 rounded-md hover:bg-blue-500 hover:text-white transition-all">
                    Manage Resources
                </a>
            </div>
        </div>
    </div>

    <!-- Community Updates -->
    <div class="lgu-card">
        <div class="lgu-card-header">
            <div class="header-icon bg-green-600 text-white">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                <h2 class="text-lg font-semibold mb-0">Community Updates</h2>
                <p class="text-xs text-gray-500 mb-0">Latest updates from your community</p>
            </div>
        </div>
        <div class="p-4">
                @if (ViewBag.CommunityUpdates != null && ViewBag.CommunityUpdates.Count > 0)
                {
                <div class="divide-y">
                        @foreach (var update in ViewBag.CommunityUpdates)
                        {
                        <div class="py-3">
                            <div class="flex justify-between items-start mb-1">
                                <span class="px-2 py-0.5 text-xs rounded-full @(update.Type == UpdateType.HelpRequest ? "bg-red-100 text-red-700" : 
                                    update.Type == UpdateType.StatusUpdate ? "bg-blue-100 text-blue-700" : 
                                    update.Type == UpdateType.ResourceSharing ? "bg-green-100 text-green-700" : 
                                    update.Type == UpdateType.Information ? "bg-purple-100 text-purple-700" : "bg-gray-100 text-gray-700")">
                                            @update.Type
                                        </span>
                                <span class="text-xs text-gray-500">@update.DatePosted.ToString("MMM dd, HH:mm")</span>
                                </div>
                            <p class="text-sm mb-1 text-gray-600 line-clamp-2">@update.Content</p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-user mr-1"></i>
                                @(update.User != null ? update.User.UserName : "Unknown User")
                            </p>
                            </div>
                        }
                    </div>
                <div class="mt-4 text-center">
                    <a href="@Url.Action("CommunityFeed", "LGU")" class="inline-block px-4 py-2 text-sm text-green-600 border border-green-600 rounded-md hover:bg-green-600 hover:text-white transition-all">
                        View Community Feed
                    </a>
                    </div>
                }
                else
                {
                <div class="text-center py-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 text-gray-500 rounded-full mb-4">
                        <i class="fas fa-comments text-3xl"></i>
                    </div>
                    <p class="text-gray-600">No community updates available.</p>
                    </div>
                }
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="lgu-card">
        <div class="lgu-card-header">
            <div class="header-icon bg-purple-600 text-white">
                <i class="fas fa-history"></i>
            </div>
            <div>
                <h2 class="text-lg font-semibold mb-0">Recent Activity</h2>
                <p class="text-xs text-gray-500 mb-0">Latest actions taken by the team</p>
            </div>
        </div>
        <div class="p-4">
            <div class="divide-y">
                <div class="py-3">
                    <div class="flex items-start">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div>
                            <p class="text-sm text-gray-800 mb-0">Report <span class="font-medium">#1234</span> marked as resolved</p>
                            <p class="text-xs text-gray-500">2 hours ago · John Doe</p>
                        </div>
                    </div>
                </div>
                <div class="py-3">
                    <div class="flex items-start">
                        <div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-bell"></i>
            </div>
                        <div>
                            <p class="text-sm text-gray-800 mb-0">New alert created for <span class="font-medium">Flood Warning</span></p>
                            <p class="text-xs text-gray-500">5 hours ago · Jane Smith</p>
                        </div>
                    </div>
                </div>
                <div class="py-3">
                    <div class="flex items-start">
                        <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-comment-dots"></i>
                            </div>
                        <div>
                            <p class="text-sm text-gray-800 mb-0">Responded to community question about evacuation</p>
                            <p class="text-xs text-gray-500">Yesterday · Admin</p>
                        </div>
                    </div>
                </div>
                <div class="py-3">
                    <div class="flex items-start">
                        <div class="w-8 h-8 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-box"></i>
                            </div>
                        <div>
                            <p class="text-sm text-gray-800 mb-0">Updated inventory of <span class="font-medium">Medical Supplies</span></p>
                            <p class="text-xs text-gray-500">2 days ago · Mark Johnson</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <a href="@Url.Action("ActivityLog", "LGU")" class="inline-block px-4 py-2 text-sm text-purple-600 border border-purple-600 rounded-md hover:bg-purple-600 hover:text-white transition-all">
                    View All Activity
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Incident Map Preview -->
<div class="lgu-card mb-6">
    <div class="lgu-card-header">
        <div class="header-icon bg-primary text-white">
            <i class="fas fa-map-marked-alt"></i>
        </div>
        <div>
            <h2 class="text-lg font-semibold mb-0">Incident Map Overview</h2>
            <p class="text-xs text-gray-500 mb-0">Geographic distribution of recent incidents</p>
        </div>
    </div>
    <div class="p-4">
        <div id="map-preview" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center">
            <span class="text-gray-400">Loading map...</span>
        </div>
        <div class="mt-4 text-center">
            <a href="@Url.Action("IncidentMap", "LGU")" class="inline-block px-4 py-2 text-sm text-primary border border-primary rounded-md hover:bg-primary hover:text-white transition-all">
                Open Full Map
            </a>
        </div>
    </div>
</div> 

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Mapbox map
            if (mapboxgl) {
                mapboxgl.accessToken = 'pk.eyJ1IjoiY2hhYW5nZ2cwMTkzIiwiYSI6ImNtOHo5ODF6cDAxcTUyaXB0ODBtYXlhN3oifQ.SJ-eGgWUplbUFNE_UwK7JA';
                const map = new mapboxgl.Map({
                    container: 'map-preview',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [123.0051, 10.3157], // Center on Negros Occidental
                    zoom: 9 // Closer zoom for Negros Occidental
                });
                
                // Add navigation controls
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                
                // Set bounds to Negros Occidental
                const negrosBounds = [
                    [122.2700, 9.8500], // Southwest coordinates of Negros Occidental
                    [123.5500, 11.0500]  // Northeast coordinates of Negros Occidental
                ];
                
                // Fit map to Negros Occidental bounds
                map.fitBounds(negrosBounds, { padding: 20 });
                
                // Load actual incident data from controller
                fetch('@Url.Action("GetMapData", "LGU")')
                    .then(response => response.json())
                    .then(incidents => {
                        if (incidents && incidents.length > 0) {
                            incidents.forEach(incident => {
                                // Skip if no valid coordinates
                                if (!incident.latitude || !incident.longitude) return;
                                
                                // Set marker color based on status and severity
                                let color = '#345995'; // Default blue
                                
                                if (incident.status === 3) { // Resolved
                                    color = '#6a8d73'; // Green 
                                } else if (incident.severity === 3) { // High severity
                                    color = '#b56357'; // Red
                                } else if (incident.severity === 2) { // Medium severity
                                    color = '#e0a458'; // Orange/Yellow
                                }
                                
                                // Add marker with popup
                                new mapboxgl.Marker({ color: color })
                                    .setLngLat([incident.longitude, incident.latitude])
                                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                                        .setHTML(`
                                            <h4 class="text-sm font-bold">${incident.title}</h4>
                                            <p class="text-xs">${incident.location}</p>
                                            <p class="text-xs">Status: ${getStatusName(incident.status)}</p>
                                        `))
                                    .addTo(map);
                            });
                        } else {
                            // If no incidents, add sample markers within Negros Occidental
                            const sampleIncidents = [
                                { lng: 122.9389, lat: 10.6713, type: 'Flood', severity: 'High', title: 'Sample: Flood in Bacolod', location: 'Bacolod City' },
                                { lng: 123.0175, lat: 10.2494, type: 'Fire', severity: 'Medium', title: 'Sample: Fire Incident', location: 'Kabankalan City' },
                                { lng: 123.1393, lat: 10.7731, type: 'Landslide', severity: 'Low', title: 'Sample: Minor Landslide', location: 'Silay City' }
                            ];
                            
                            sampleIncidents.forEach(incident => {
                                const color = incident.severity === 'High' ? '#ef4444' : 
                                            incident.severity === 'Medium' ? '#f59e0b' : '#3b82f6';
                                
                                // Add marker with popup
                                new mapboxgl.Marker({ color: color })
                                    .setLngLat([incident.lng, incident.lat])
                                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                                        .setHTML(`
                                            <h4 class="text-sm font-bold">${incident.title}</h4>
                                            <p class="text-xs">${incident.location}</p>
                                            <p class="text-xs">Type: ${incident.type}</p>
                                            <p class="text-xs">Severity: ${incident.severity}</p>
                                            <p class="text-xs text-gray-500 mt-1">This is sample data</p>
                                        `))
                                    .addTo(map);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching map data:', error);
                        // Show error on map
                        const mapContainer = document.getElementById('map-preview');
                        if (mapContainer) {
                            mapContainer.innerHTML = '<div class="p-4 text-center text-red-500">Error loading incident data</div>';
                        }
                    });
            }
            
            // Helper function to get status name
            function getStatusName(status) {
                const statuses = ['Pending', 'Verified', 'InProgress', 'Resolved', 'Declined'];
                return statuses[status] || 'Unknown';
            }
        });
    </script>
} 