@model THYNK.Models.DisasterReport
@{
    ViewData["Title"] = "Report Incident";
    Layout = "_CommunityLayout";
}

<div class="row">
    <div class="col-md-8">
        <div class="card dashboard-card">
            <div class="card-header bg-danger text-white">
                <div class="d-flex align-items-center">
                    <div class="card-icon bg-white text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div>
                        <h5 class="m-0">Report Incident</h5>
                        <small>Submit details about a disaster or accident</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form asp-action="SubmitReport" method="post" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="mb-3">
                        <label asp-for="Title" class="form-label">Title</label>
                        <input asp-for="Title" class="form-control" placeholder="Brief title of the incident" required />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Type" class="form-label">Incident Type</label>
                        <select asp-for="Type" class="form-select" required>
                            @foreach (var type in Enum.GetValues(typeof(DisasterType)))
                            {
                                <option value="@type">@type</option>
                            }
                        </select>
                        <span asp-validation-for="Type" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Detailed description of what happened" required></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Severity" class="form-label">Severity Level</label>
                        <select asp-for="Severity" class="form-select" required>
                            @foreach (var severity in Enum.GetValues(typeof(SeverityLevel)))
                            {
                                <option value="@severity">@severity</option>
                            }
                        </select>
                        <span asp-validation-for="Severity" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <div class="input-group mb-2">
                            <input asp-for="Location" id="location" class="form-control" placeholder="Enter address or location name" required />
                            <button type="button" class="btn btn-primary" id="detect-location">
                                <i class="fas fa-map-marker-alt"></i> Detect
                            </button>
                        </div>
                        <span asp-validation-for="Location" class="text-danger"></span>
                        <small class="text-muted">Click 'Detect' to automatically get your current location, or manually input an address.</small>
                    </div>

                    <!-- Hidden fields for coordinates -->
                    <input type="hidden" asp-for="Latitude" id="latitude" />
                    <input type="hidden" asp-for="Longitude" id="longitude" />

                    <div class="mb-3">
                        <label class="form-label">Photo (Optional)</label>
                        <input type="file" class="form-control" id="photo" name="photo" accept="image/*" />
                        <small class="text-muted">Upload a photo of the incident if available.</small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="AdditionalInfo" class="form-label">Additional Information (Optional)</label>
                        <textarea asp-for="AdditionalInfo" class="form-control" rows="3" placeholder="Any other details you'd like to share"></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a asp-action="Dashboard" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-danger">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card dashboard-card">
            <div class="card-header bg-info text-white">
                <h5 class="m-0"><i class="fas fa-info-circle me-2"></i>Reporting Guidelines</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-check-circle text-success me-2"></i>Be Accurate</h6>
                    <p class="small">Provide as much accurate information as possible to help responders.</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-check-circle text-success me-2"></i>Be Clear</h6>
                    <p class="small">Use simple and clear language to describe the incident.</p>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-check-circle text-success me-2"></i>Be Safe</h6>
                    <p class="small">Only submit a report if you are in a safe location away from danger.</p>
                </div>
                <div>
                    <h6><i class="fas fa-check-circle text-success me-2"></i>Be Timely</h6>
                    <p class="small">Report incidents as soon as safely possible to allow for quicker response.</p>
                </div>
                <hr />
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Important:</strong> For emergencies requiring immediate assistance, please call emergency services directly.
                </div>
            </div>
        </div>
        <div class="card dashboard-card mt-3">
            <div class="card-body">
                <h6 class="card-title">Selected Location</h6>
                <div id="map" class="map-preview" style="height: 250px; border-radius: 5px;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Initialize the map
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2hhYW5nZ2cwMTkzIiwiYSI6ImNtOHo5ODF6cDAxcTUyaXB0ODBtYXlhN3oifQ.SJ-eGgWUplbUFNE_UwK7JA'; // Replace with your Mapbox access token
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [120.9842, 14.5995], // Default to Philippines
            zoom: 12
        });

        // Add map controls
        map.addControl(new mapboxgl.NavigationControl());
        
        // Create a marker
        const marker = new mapboxgl.Marker({
            draggable: true
        }).setLngLat([120.9842, 14.5995])
          .addTo(map);

        // Update coordinates when marker is dragged
        marker.on('dragend', function() {
            const lngLat = marker.getLngLat();
            document.getElementById('latitude').value = lngLat.lat;
            document.getElementById('longitude').value = lngLat.lng;
            updateLocationName(lngLat.lat, lngLat.lng);
        });

        // Detect current location
        document.getElementById('detect-location').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update form fields
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;
                    
                    // Update map
                    map.setCenter([lng, lat]);
                    marker.setLngLat([lng, lat]);
                    
                    // Get location name
                    updateLocationName(lat, lng);
                }, function(error) {
                    console.error('Error getting location:', error);
                    alert('Could not get your location. Please enter it manually.');
                });
            } else {
                alert('Geolocation is not supported by your browser. Please enter your location manually.');
            }
        });

        // Function to get location name from coordinates using reverse geocoding
        function updateLocationName(lat, lng) {
            // Using Mapbox Geocoding API
            fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        document.getElementById('location').value = data.features[0].place_name;
                    }
                })
                .catch(error => {
                    console.error('Error reverse geocoding:', error);
                });
        }
    </script>
}

@section Styles {
    <style>
        .map-preview {
            width: 100%;
            border: 1px solid #ddd;
        }
    </style>
} 